name: PHP Auto-Fix & Quality Check

# allow workflow to push and update checks; keep minimal permissions
permissions:
  contents: write
  checks: write

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # install PHPCBF only (no auto-commit here)
  phpcbf-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          persist-credentials: false

      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          coverage: none

      - name: Install PHPCS (composer global)
        run: |
          composer global require squizlabs/php_codesniffer
          echo "$HOME/.config/composer/vendor/bin" >> $GITHUB_PATH

  # Run PHPCS + PHPStan on multiple PHP versions and apply fixes to the same commit (if needed)
  php-quality:
    runs-on: ubuntu-latest
    needs: phpcbf-fix
    strategy:
      fail-fast: false
      matrix:
        php-version: [7.3, 7.4, 8.0, 8.1, 8.2, 8.3]

    steps:
      - name: Checkout code (allow pushing and full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          coverage: none

      - name: Add composer global bin to PATH
        run: echo "$HOME/.config/composer/vendor/bin" >> $GITHUB_PATH

      - name: Install PHPStan and PHPCS (if not available)
        run: |
          composer global require phpstan/phpstan squizlabs/php_codesniffer || true
          echo "$HOME/.config/composer/vendor/bin" >> $GITHUB_PATH

      - name: Run PHPStan
        run: phpstan analyse phpcbf --memory-limit=1G

      - name: Determine branch name
        run: echo "BRANCH_NAME=${{ github.head_ref || github.ref_name }}" >> $GITHUB_ENV

      - name: Run PHPCBF (auto-fix)
        id: phpcbf
        run: |
          # run auto-fixer and handle its exit code without using '|| true'
          phpcbf --standard=PSR12 phpcbf/
          EXIT_CODE=$?

          # If PHPCBF changed files, mark changed=true regardless of exit code
          if ! git diff --quiet; then
            echo "changed=true" >> $GITHUB_OUTPUT
            git --no-pager diff --name-only
            exit 0
          fi

          # No changes were made by PHPCBF
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PHPCBF returned a non-zero exit code but didn't change files -> treat as error
          echo "PHPCBF exited with code $EXIT_CODE and made no changes. Failing the step."
          exit $EXIT_CODE

      # Only one matrix job should amend & push to avoid races. use 8.3 as canonical job.
      - name: Amend commit and push fixes (only from php 8.3 matrix job)
        if: ${{ steps.phpcbf.outputs.changed == 'true' && matrix.php-version == '8.3' }}
        env:
          BRANCH: ${{ env.BRANCH_NAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # stage changes from PHPCBF
          git add -A

          # amend the last commit to keep fixes in the same commit
          # include [skip ci] to avoid triggering other workflows on this push as extra safety
          git commit --amend --no-edit -m "$(git log -1 --pretty=%B) [skip ci]" || echo "No changes to commit"

          # push using the GITHUB_TOKEN and force-with-lease to update the same branch
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} HEAD:${BRANCH} --force-with-lease

      - name: Run PHPCS (lint only)
        run: phpcs --standard=PSR12 --warning-severity=0 phpcbf/