name: PHP Auto-Fix & Quality Check

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ðŸ”§ Auto-fix coding standards (only once, PHP 8.1)
  phpcbf-fix:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Checkout code (allow pushing)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0
          persist-credentials: true

      # 2ï¸âƒ£ Setup PHP (single version for auto-fix)
      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          coverage: none

      # 3ï¸âƒ£ Install PHPCS
      - name: Install PHPCS
        run: |
          composer global require squizlabs/php_codesniffer
          echo "$HOME/.config/composer/vendor/bin" >> $GITHUB_PATH

      # 4ï¸âƒ£ Run PHPCBF (auto-fix issues). Fail on phpcbf error. If fixes applied, commit, re-check and push.
      # ...existing code...
      - name: Run PHPCBF and commit fixes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -o pipefail

          echo "Running PHPCBF (first pass)..."
          phpcbf --standard=PSR12 phpcbf/ 2>&1 | tee phpcbf-output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          # If PHPCBF changed files -> commit, verify and push
          if ! git diff --quiet; then
            echo "PHPCBF modified files â€” committing fixes."
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "PHPCBF: auto-fix coding standards" || echo "Nothing to commit"

            echo "Re-running PHPCBF on committed state (verification)..."
            phpcbf --standard=PSR12 phpcbf/ 2>&1 | tee phpcbf-output-2.txt
            EXIT_CODE2=${PIPESTATUS[0]}

            if [ "$EXIT_CODE2" -ne 0 ]; then
              echo "PHPCBF verification run failed with code $EXIT_CODE2. See output:"
              cat phpcbf-output-2.txt || true
              exit $EXIT_CODE2
            fi

            echo "Pushing fixes back to branch."
            BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:$BRANCH --force-with-lease
            exit 0
          fi

          # No files changed by PHPCBF â€” run PHPCS to determine if there are remaining issues.
          echo "No files changed by PHPCBF. Running PHPCS to check for remaining issues..."
          phpcs --standard=PSR12 --warning-severity=0 phpcbf/ 2>&1 | tee phpcs-output.txt
          PHPCS_EXIT=${PIPESTATUS[0]}

          if [ "$PHPCS_EXIT" -eq 0 ]; then
            echo "No lint errors found. Finishing job."
            exit 0
          fi

          echo "Lint errors remain (PHPCS exit $PHPCS_EXIT). Show outputs:"
          echo "---- PHPCBF output ----"
          cat phpcbf-output.txt || true
          echo "---- PHPCS output ----"
          cat phpcs-output.txt || true

          # Fail so author fixes non-fixable issues locally
          exit $PHPCS_EXIT