name: PHP Auto-Fix & Quality Check

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ðŸ”§ Auto-fix coding standards (only once, PHP 8.1)
  phpcbf-fix:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Checkout code (allow pushing)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0
          persist-credentials: true

      # 2ï¸âƒ£ Setup PHP (single version for auto-fix)
      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          coverage: none

      # 3ï¸âƒ£ Install PHPCS
      - name: Install PHPCS
        run: |
          composer global require squizlabs/php_codesniffer
          echo "$HOME/.config/composer/vendor/bin" >> $GITHUB_PATH

      # 4ï¸âƒ£ Ensure phpcbf is available (retry a few times) before running it
      - name: Wait for phpcbf to be available
        run: |
          RETRIES=6
          COUNT=0
          until command -v phpcbf >/dev/null 2>&1 || [ $COUNT -ge $RETRIES ]; do
            echo "phpcbf not found yet, sleeping..."
            sleep 2
            COUNT=$((COUNT+1))
          done
          if ! command -v phpcbf >/dev/null 2>&1; then
            echo "phpcbf not available after retries. Listing composer bin for debugging:"
            ls -la "$HOME/.config/composer/vendor/bin" || true
            exit 1
          fi
          echo "phpcbf is available at: $(command -v phpcbf)"

      # 5ï¸âƒ£ Run PHPCBF (auto-fix issues). Fail on phpcbf error. If fixes applied, commit, re-check and push.
      - name: Run PHPCBF and commit fixes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -o pipefail

          set +e

          echo "Running PHPCBF (first pass)..."
          phpcbf --standard=PSR12 phpcbf/ 2>&1 | tee phpcbf-output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          # PHPCBF sometimes returns non-zero for 'No fixable errors were found'. Treat that as success.
          if [ "$EXIT_CODE" -ne 0 ]; then
            if grep -qi "No fixable errors were found" phpcbf-output.txt; then
              echo "PHPCBF reported no fixable errors; treating as success."
              EXIT_CODE=0
            fi
          fi

          # If PHPCBF changed files -> commit, verify and push
          if ! git diff --quiet; then
            echo "PHPCBF modified files â€” committing fixes."
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "PHPCBF: auto-fix coding standards [skip ci]" || echo "Nothing to commit"

            echo "Re-running PHPCBF on committed state (verification)..."
            phpcbf --standard=PSR12 phpcbf/ 2>&1 | tee phpcbf-output-2.txt
            EXIT_CODE2=${PIPESTATUS[0]}

            if [ "$EXIT_CODE2" -ne 0 ]; then
              echo "PHPCBF verification run failed with code $EXIT_CODE2. See output:"
              cat phpcbf-output-2.txt || true
              exit $EXIT_CODE2
            fi

            echo "Pushing fixes back to branch."
            BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:$BRANCH --force-with-lease
            exit 0
          fi

          # No files changed by PHPCBF.
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "PHPCBF completed with no changes and no errors. Finishing job."
            exit 0
          fi

          # PHPCBF returned non-zero and made no changes -> show diagnostics and run PHPCS
          echo "PHPCBF exited with code $EXIT_CODE and made no changes. Showing outputs and running PHPCS for details:"
          echo "---- PHPCBF output ----"
          cat phpcbf-output.txt || true

          echo "Running PHPCS to list remaining issues..."
          phpcs --standard=PSR12 --warning-severity=0 phpcbf/ 2>&1 | tee phpcs-output.txt
          PHPCS_EXIT=${PIPESTATUS[0]}

          echo "---- PHPCS output ----"
          cat phpcs-output.txt || true

          # Fail so author fixes non-fixable issues locally
          exit $PHPCS_EXIT